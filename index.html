<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Purchase Order- Notes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

label {
    display: block;
    margin-top: 10px;
    font-weight: 600;
    font-size: 14px;
}

body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 20px;
}

.container {
    max-width: 520px;
    margin: auto;
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

h2 {
    text-align: center;
}

input, textarea {
    width: 100%;
    padding: 8px;
    margin-top: 8px;
    box-sizing: border-box;
    border-radius: 6px;
    border: 1px solid #ccc;
}

textarea {
    height: 80px;
}

button {
    padding: 8px 12px;
    margin-top: 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

.add-btn {
    width: 100%;
    background: #4CAF50;
    color: white;
}

.export-btn {
    width: 100%;
    background: #6a1b9a;
    color: white;
}

.note {
    background: #fafafa;
    padding: 10px;
    border-radius: 6px;
    margin-top: 12px;
    border: 1px solid #ddd;
}

.note small {
    color: #666;
}

.note-actions {
    margin-top: 6px;
    display: flex;
    gap: 6px;
}

.edit { background: #2196F3; color: white; }
.delete { background: #f44336; color: white; }
.share { background: #25D366; color: white; }
</style>
</head>

<body>

<div class="container">
<h2>üìù Daily Notes</h2>

<label>Date <span style="color:red">*</span></label>
<input type="date" id="noteDate" required>

<label>Time</label>
<input type="time" id="noteTime">

<label>Price</label>
<input type="number" id="price" placeholder="e.g. 120.50" oninput="updateTotal()">

<label>Quantity</label>
<input type="number" id="quantity" placeholder="e.g. 2" oninput="updateTotal()">

<label>Total</label>
<input type="number" id="total" readonly placeholder="Auto-calculated">

<label>Manufacture Date</label>
<input type="date" id="mfgDate">

<label>Expiry Date</label>
<input type="date" id="expDate">

<label>Notes / Description</label>
<textarea id="noteInput" placeholder="Optional description..."></textarea>

<button class="add-btn" onclick="addNote()">Add Entry</button>
<button class="export-btn" onclick="exportCSV()">Export CSV</button>


    <div id="notesList"></div>
    </div>

<script>
/* ---------- GLOBAL STATE ---------- */
let notes = JSON.parse(localStorage.getItem("notes")) || [];
let editIndex = null;

function calculateDateTotal(date) {
    return notes
        .filter(n => n.date === date)
        .reduce((sum, n) => sum + (parseFloat(n.total) || 0), 0)
        .toFixed(2);
}

function calculateGrandTotal() {
    return notes
        .reduce((sum, n) => sum + (parseFloat(n.total) || 0), 0)
        .toFixed(2);
}


/* ---------- STORAGE ---------- */
function saveNotes() {
    localStorage.setItem("notes", JSON.stringify(notes));
}

/* ---------- RENDER ---------- */
function renderNotes() {
    const list = document.getElementById("notesList");
    list.innerHTML = "";

    if (notes.length === 0) return;

    const grouped = {};

    // Group entries by date
    notes.forEach(n => {
        if (!grouped[n.date]) grouped[n.date] = [];
        grouped[n.date].push(n);
    });

    // Render date-wise
    Object.keys(grouped).forEach(date => {
        const dateHeader = document.createElement("h3");
        dateHeader.innerText = `üìÖ ${date} ‚Äî Total: ‚Çπ${calculateDateTotal(date)}`;
        list.appendChild(dateHeader);

        grouped[date].forEach((note, index) => {
            const div = document.createElement("div");
            div.className = "note";

            div.innerHTML = `
                <div>${note.text || "<i>No notes</i>"}</div>
                <small>
                    üí∞ ${note.price || "-"} |
                    üì¶ ${note.quantity || "-"} |
                    üßÆ ${note.total || "-"}<br>
                    üè≠ ${note.mfgDate || "-"} |
                    ‚è≥ ${note.expDate || "-"}
                </small>

                <div class="note-actions">
                    <button class="edit" onclick="editNote(${notes.indexOf(note)})">Edit</button>
                    <button class="delete" onclick="deleteNote(${notes.indexOf(note)})">Delete</button>
                    <button class="share" onclick="shareNote(${notes.indexOf(note)})">Share</button>
                </div>
            `;
            list.appendChild(div);
        });
    });

    // Grand Total
    const grand = document.createElement("h2");
    grand.style.marginTop = "15px";
    grand.innerText = `üßæ Grand Total: ‚Çπ${calculateGrandTotal()}`;
    list.appendChild(grand);
}

/* ---------- ADD / UPDATE ---------- */
function addNote() {
    const date = document.getElementById("noteDate").value;

    if (!date) {
        alert("Date is mandatory");
        return;
    }

    const entry = {
    date: date,
    time: document.getElementById("noteTime").value || "",
    text: document.getElementById("noteInput").value.trim(),
    price: document.getElementById("price").value || "",
    quantity: document.getElementById("quantity").value || "",
    total: document.getElementById("total").value || "",
    mfgDate: document.getElementById("mfgDate").value || "",
    expDate: document.getElementById("expDate").value || ""
};


    if (editIndex !== null) {
        notes[editIndex] = entry;
        editIndex = null;
        document.querySelector(".add-btn").innerText = "Add Entry";
    } else {
        notes.unshift(entry);
    }

    clearForm();
    saveNotes();
    renderNotes();
}

/* ---------- EDIT ---------- */
function editNote(index) {
    const n = notes[index];

    document.getElementById("noteDate").value = n.date || "";
    document.getElementById("noteTime").value = n.time || "";
    document.getElementById("price").value = n.price || "";
    document.getElementById("quantity").value = n.quantity || "";
    document.getElementById("total").value = n.total || "";

    document.getElementById("mfgDate").value = n.mfgDate || "";
    document.getElementById("expDate").value = n.expDate || "";
    document.getElementById("noteInput").value = n.text || "";

    editIndex = index;
    document.querySelector(".add-btn").innerText = "Update Entry";
}

/* ---------- DELETE ---------- */
function deleteNote(index) {
    if (confirm("Delete this entry?")) {
        notes.splice(index, 1);
        saveNotes();
        renderNotes();
    }
}

function updateTotal() {
    // Total should just reflect the entered Price, NOT price * quantity.
    const price = parseFloat(document.getElementById("price").value) || 0;
    document.getElementById("total").value = price.toFixed(2);
}

function calculateGrandTotal() {
    let sum = 0;

    notes.forEach(n => {
        sum += parseFloat(n.total) || 0;
    });

    return sum.toFixed(2);
}



/* ---------- SHARE ---------- */
function shareNote(index) {
    const n = notes[index];
    const msg = `üìù Entry
üìÖ ${n.date}
‚è∞ ${n.time || "-"}
üí∞ ${n.price || "-"}
üì¶ ${n.quantity || "-"}
üè≠ ${n.mfgDate || "-"}
‚è≥ ${n.expDate || "-"}

${n.text || ""}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
}

/* ---------- EXPORT CSV ---------- */
function exportCSV() {
    if (!notes || notes.length === 0) {
        alert("No entries available to export");
        return;
    }

    const headers = [
    "Date",
    "Time",
    "Notes",
    "Price",
    "Quantity",
    "Total",
    "Manufacture Date",
    "Expiry Date"
];


    let csvRows = [];
    csvRows.push(headers.join(","));

    notes.forEach(n => {
        const row = [
    n.date || "",
    n.time || "",
    `"${(n.text || "").replace(/"/g, '""')}"`,
    n.price || "",
    n.quantity || "",
    n.total || "",
    n.mfgDate || "",
    n.expDate || ""
];

        csvRows.push(row.join(","));
    });

    // empty row for spacing
csvRows.push("");

// grand total row
csvRows.push([
    "",
    "",
    "Grand Total",
    "",
    "",
    calculateGrandTotal(),
    "",
    ""
].join(","));


    const csvContent = csvRows.join("\n");

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = "daily_notes.csv";
    document.body.appendChild(link);
    link.click();

    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}


/* ---------- UTIL ---------- */
function clearForm() {
    document.getElementById("noteDate").value = "";
    document.getElementById("noteTime").value = "";
    document.getElementById("price").value = "";
    document.getElementById("quantity").value = "";
    document.getElementById("total").value = "";

    document.getElementById("mfgDate").value = "";
    document.getElementById("expDate").value = "";
    document.getElementById("noteInput").value = "";
}

/* ---------- INIT ---------- */
renderNotes();
</script>

</body>
</html>
